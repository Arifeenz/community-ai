<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</title>
  <style>
    /* ---------- Theme Tokens ---------- */
    :root{
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --border: #e2e8f0;
      --primary: #16a34a;
      --primary-600:#15803d;
      --accent: #06b6d4;
      --ai: #fce4ec;
      --ai-text:#ad1457;
      --user:#c8e6c9;
      --user-text:#1b5e20;
      --shadow: 0 10px 30px rgba(15, 23, 42, 0.12);
      --ring: #22c55e;
    }
    :root.theme-dark{
      --bg: #0b1220;
      --card: #0f172a;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --border:#243041;
      --primary:#22c55e;
      --primary-600:#16a34a;
      --accent:#22d3ee;
      --ai:#2b1d24;
      --ai-text:#f8b4c8;
      --user:#19321b;
      --user-text:#b7f7bf;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --ring:#22c55e;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans Thai", "Noto Sans", Arial, sans-serif;
      color:var(--text); background:
        radial-gradient(1000px 600px at 10% 0%, rgba(34,197,94,.08), transparent),
        radial-gradient(1000px 600px at 90% 100%, rgba(6,182,212,.08), transparent),
        var(--bg);
      padding: 20px;
      transition: background .25s ease, color .2s ease;
    }

    /* ---------- Layout ---------- */
    .container{
      max-width: 1200px; margin: 0 auto;
      display: grid; gap: 24px;
      grid-template-columns: 1fr 320px;
    }
    @media (max-width: 960px){ .container{ grid-template-columns: 1fr; } }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 20px;
    }

    /* ---------- Header ---------- */
    .page-header{
      display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom: 16px;
    }
    .title{ display:flex; align-items:center; gap:12px; }
    .logo{
      width:42px; height:42px; border-radius:12px; display:grid; place-items:center;
      background: linear-gradient(135deg, var(--primary), var(--accent));
      color:#fff; font-weight:700;
    }
    h1{margin:0; font-size: clamp(20px, 2.5vw, 28px);}
    .meta{color:var(--muted); font-size: 14px; margin-top:4px}

    /* ---------- Sidebar ---------- */
    .sidebar h2{margin: 0 0 10px}
    .activity-box{
      border:1px solid var(--border);
      background: color-mix(in srgb, var(--card) 90%, var(--bg));
      border-radius: 12px;
      padding: 12px; margin-bottom:12px;
    }
    .preview .activity-box{ outline: 2px dashed color-mix(in srgb, var(--ring) 40%, transparent); }

    /* Audience select */
    .audience{
      display:block; border:1px dashed var(--border); border-radius: 10px;
      padding: 10px; margin: 8px 0 0; background: color-mix(in srgb, var(--card) 92%, var(--bg));
    }
    .audience legend{ font-weight:700; font-size:14px; color: var(--text) }
    .audience .opts{ display:flex; gap:10px; flex-wrap:wrap; margin-top:6px }
    .audience label{
      display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border:1px solid var(--border);
      border-radius:999px; cursor:pointer; background: var(--card);
    }
    .audience input{ accent-color: var(--primary); }

    /* ---------- AI content ---------- */
    #aiContentBox{ display:none }
    .ai-card{
      background: color-mix(in srgb, var(--card) 85%, var(--ai) );
      border:1px solid var(--border);
      border-radius: 12px; padding:16px;
    }
    .ai-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px }
    .btn{
      appearance:none; border:none; cursor:pointer;
      padding:10px 14px; border-radius:10px; font-weight:600;
      background: var(--primary); color:#fff;
      transition: transform .03s, background .15s, opacity .15s, box-shadow .15s;
      box-shadow: 0 4px 14px rgba(34,197,94,.25);
    }
    .btn:hover{ background: var(--primary-600) }
    .btn.secondary{ background: #6b7280; box-shadow: none; }
    .btn.fb{ background:#4267b2; }
    .btn:active{ transform: translateY(1px) }

    /* ---------- Chat trigger button ---------- */
    .chat-button{
      position: fixed;
      left: 50%; transform: translateX(-50%);
      bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      background: var(--primary); color:#fff; padding: 14px 20px; border-radius: 999px;
      font-size: 16px; cursor: pointer; box-shadow: var(--shadow); z-index: 1000; border: none;
      transition: opacity .15s ease;
    }
    @media (max-width: 768px){
      .chat-button{
        right: 16px; left: auto; transform: none;
        bottom: calc(16px + env(safe-area-inset-bottom, 0px));
      }
      body.chat-open .chat-button{
        opacity: 0; pointer-events: none;
      }
    }

    /* ---------- Chat box ---------- */
    #chatBox{
      position: fixed;
      right: 16px;
      bottom: calc(80px + env(safe-area-inset-bottom, 0px));
      width: min(380px, 94vw);
      height: 520px;
      display:none; flex-direction: column;
      background: var(--card); border:1px solid var(--border);
      border-radius: 14px; box-shadow: var(--shadow);
      z-index: 999; overflow: hidden;
    }
    #chatMessages{
      flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:6px;
      scroll-behavior: smooth;
    }
    .bubble{
      max-width: 85%; padding: 8px 12px; border-radius: 12px; margin: 2px 0;
      word-wrap: break-word; line-height:1.35; border: 1px solid var(--border);
    }
    .ai{ align-self:flex-start; background: var(--ai); color: var(--ai-text); }
    .user{ align-self:flex-end; background: var(--user); color: var(--user-text); }

    /* Chat input bar */
    #chatInput{
      display:flex; align-items:center; gap: 8px; padding: 8px;
      border-top:1px solid var(--border); background: var(--card); width: 100%;
    }
    #chatInput input{
      font-size:16px; /* ‡∏Å‡∏±‡∏ô iOS ‡∏ã‡∏π‡∏° */
      flex:1; min-width: 0; padding:12px 14px; border:none; background:transparent; color:var(--text); outline:none;
    }
    #chatInput .send-btn{
      flex: 0 0 auto; min-width: 88px; border:none; background: var(--primary); color:#fff;
      padding: 10px 14px; border-radius: 10px; font-weight: 600; cursor:pointer;
    }
    #chatInput .voice-btn{
      flex: 0 0 auto; min-width: 56px; border:none; background:#f59e0b; color:#fff;
      padding: 10px 12px; border-radius: 10px; font-weight: 700; cursor:pointer;
    }
    @media (max-width: 480px){
      #chatInput .send-btn{ padding: 12px 16px; font-size: 16px; }
      #chatInput .voice-btn{ padding: 12px 14px; font-size: 18px; }
    }

    /* ---------- Theme Toggle ---------- */
    .theme-toggle{
      display:inline-flex; align-items:center; gap:8px;
      background: transparent; color: var(--text);
      border:1px solid var(--border); padding:8px 12px; border-radius: 999px; cursor: pointer;
    }
    .theme-toggle:hover{ background: color-mix(in srgb, var(--bg) 60%, transparent); }
    .theme-toggle svg{ width:18px; height:18px; display:block }

    /* ---------- Utilities ---------- */
    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center }
    .muted{ color: var(--muted) }
    pre, textarea { white-space: pre-wrap; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Main -->
    <section class="card">
      <header class="page-header">
        <div class="title">
          <div class="logo" aria-hidden="true">‡∏ä</div>
          <div>
            <h1 id="communityTitle">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ä‡∏∏‡∏°‡∏ä‡∏ô</h1>
            <div class="meta">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå</div>
          </div>
        </div>
        <button id="themeToggle" class="theme-toggle" type="button" aria-pressed="false">
          <span id="themeIcon" aria-hidden="true"></span>
          <span id="themeText">‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á</span>
        </button>
      </header>

      <div class="row muted" style="gap:18px; margin-bottom:10px">
        <div>üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å: 125 ‡∏Ñ‡∏ô</div>
        <div>üìÖ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô 28 ‡∏Å.‡∏Ñ. 2025</div>
        <div>üì¢ ‡∏Ç‡πà‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®: ‡πÄ‡∏ä‡∏¥‡∏ç‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏õ‡∏•‡∏π‡∏Å‡∏õ‡πà‡∏≤ 10 ‡∏™.‡∏Ñ. 2025</div>
      </div>

      <div id="aiContentBox" class="ai-card">
        <h2 style="margin:0 0 8px">üì¢ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å AI</h2>
        <p id="aiGeneratedContent"></p>
        <div class="muted" style="font-size:12px">üí° ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏†‡∏≤‡∏û‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏î‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</div>
        <div class="ai-actions">
          <button class="btn" id="shortenBtn" onclick="shortenContent()">‚úÇÔ∏è ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö</button>
          <button class="btn secondary" onclick="copyPostText()">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</button>
          <button class="btn fb" onclick="openFacebookPost()">üì§ ‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏ö‡∏ô Facebook</button>
        </div>
      </div>
    </section>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="card">
        <h2>‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h2>
        <div id="activityList"></div>
      </div>
      <div class="card preview" style="margin-top:16px">
        <h2>‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡∏°‡πà (Preview)</h2>
        <div id="activityPreview"></div>
      </div>
    </aside>
  </div>

  <!-- Chat -->
  <div id="chatBox" role="dialog" aria-label="‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÅ‡∏ä‡∏ó‡∏û‡∏•‡∏≠‡∏¢‡πÉ‡∏™">
    <div id="chatMessages"></div>
    <div id="chatInput">
      <input type="text" id="userMsg" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î üé§..." />
      <button class="send-btn" onclick="sendMsg()" aria-label="‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°">‡∏™‡πà‡∏á</button>
      <button class="voice-btn" id="voiceBtn" onclick="startVoice()" aria-label="‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏û‡∏π‡∏î">üé§</button>
    </div>
  </div>
  <button class="chat-button" onclick="toggleChat()">üí¨ ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡∏û‡∏•‡∏≠‡∏¢‡πÉ‡∏™</button>

  <script>
    /* ---------- Google Sheet Web App URL ---------- */
    const SHEET_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyRiQ40M8zo9wDdniSXfMu73_sAgqjGA8XK-c3kian9oAp8mE7xp-z0ysCZtfdKfiSJ/exec";

    async function sendToSheet(payload){
      try{
        await fetch(SHEET_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'text/plain;charset=utf-8' }, // no-cors friendly
          body: JSON.stringify(payload),
          mode: 'no-cors'
        });
      }catch(err){
        console.warn('Send to sheet fail:', err);
      }
    }

    /* ---------- Backend URL helpers ---------- */
    function getBackendUrl(){
      if (location.hostname === 'localhost' || location.protocol === 'file:') {
        return 'http://localhost:3001/generate';
      }
      return '/api/generate';
    }
    async function fetchJSON(url, options={}){
      const res = await fetch(url, options);
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) return res.json();
      const t = await res.text();
      try { return JSON.parse(t); } catch { throw new Error('‡πÑ‡∏°‡πà‡∏û‡∏ö JSON ‡∏à‡∏≤‡∏Å‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå'); }
    }

    /* ---------- Init Community Title ---------- */
    const communityName = localStorage.getItem("communityName") || "‡∏ä‡∏∏‡∏°‡∏ä‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì";
    document.getElementById("communityTitle").textContent = "üè° " + communityName;

    /* ---------- Elements ---------- */
    const chatBox = document.getElementById("chatBox");
    const chatMessages = document.getElementById("chatMessages");
    const userInput = document.getElementById("userMsg");
    const activityPreview = document.getElementById("activityPreview");
    const activityList = document.getElementById("activityList");
    const aiContentEl = document.getElementById("aiGeneratedContent");
    const aiBox = document.getElementById("aiContentBox");
    const shortenBtn = document.getElementById("shortenBtn");

    /* ---------- Theme Toggle ---------- */
    const root = document.documentElement;
    const tBtn = document.getElementById("themeToggle");
    const tIcon = document.getElementById("themeIcon");
    const tText = document.getElementById("themeText");

    function themeIcon(mode){
      const sun = '<svg viewBox="0 0 24 24" fill="none"><path d="M12 4V2m0 20v-2M4 12H2m20 0h-2M5 5 3.6 3.6M20.4 20.4 19 19m0-14 1.4-1.4M5 19 3.6 20.4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><circle cx="12" cy="12" r="4" stroke="currentColor" stroke-width="2"/></svg>';
      const moon = '<svg viewBox="0 0 24 24" fill="none"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
      tIcon.innerHTML = mode === 'dark' ? moon : sun;
      tText.textContent = mode === 'dark' ? '‡πÇ‡∏´‡∏°‡∏î‡∏°‡∏∑‡∏î' : '‡πÇ‡∏´‡∏°‡∏î‡∏™‡∏ß‡πà‡∏≤‡∏á';
      tBtn.setAttribute('aria-pressed', mode === 'dark');
    }
    function applyTheme(mode){
      root.classList.toggle('theme-dark', mode === 'dark');
      themeIcon(mode);
      try{ localStorage.setItem('theme', mode); }catch(e){}
    }
    function detectTheme(){
      const saved = localStorage.getItem('theme');
      if(saved) return saved;
      return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark':'light';
    }
    (function(){ applyTheme(detectTheme()); })();
    tBtn.addEventListener('click', () => applyTheme(root.classList.contains('theme-dark') ? 'light' : 'dark'));

    /* ---------- Chat helpers ---------- */
    function scrollChatToBottom(){
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          chatMessages.scrollTop = chatMessages.scrollHeight;
        });
      });
    }
    function showChat(){
      chatBox.style.display = 'flex';
      document.body.classList.add('chat-open');
      setTimeout(() => { userInput?.focus(); scrollChatToBottom(); }, 50);
    }
    function minimizeChat(){
      chatBox.style.display = 'none';
      document.body.classList.remove('chat-open');
    }

    /* ---------- Chat & Flow ---------- */
    let step = 0;
    let selectedType = "activity";
    let currentData = {};
    let editingIndex = null;
    let targetAudience = 'work'; // 'teen' | 'work' | 'senior' (‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå ‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô)

    const templates = {
      activity: [
        "‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞?",
        "‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞?",
        "‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏à‡∏±‡∏î‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?",
        "‡∏à‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô? (‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î)",
        "‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏´‡∏°? ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏Ñ‡∏∞?",
      ],
      place: [
        "‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞?",
        "‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡∏ö‡∏•/‡∏≠‡∏≥‡πÄ‡∏†‡∏≠‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?",
        "‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ö‡πâ‡∏≤‡∏á?",
        "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÑ‡∏á‡πÑ‡∏î‡πâ‡∏ö‡πâ‡∏≤‡∏á?",
        "‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô? ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏î?",
        "‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ä‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏Ñ‡∏∞?",
      ],
      restaurant: [
        "‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞?",
        "‡∏£‡πâ‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô?",
        "‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á?",
        "‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏ß‡∏±‡∏ô‡πÑ‡∏´‡∏ô? ‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏î?",
        "‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞?",
      ],
      hotel: [
        "‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°/‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ß‡πà‡∏≤‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞?",
        "‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?",
        "‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞?",
        "‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏î‡∏ö‡πâ‡∏≤‡∏á? ‡∏£‡∏≤‡∏Ñ‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà?",
        "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏î‡πâ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡πÉ‡∏î‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞?",
      ],
      shop: [
        "‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏Ñ‡∏∞?",
        "‡∏£‡πâ‡∏≤‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞? (‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà/‡∏à‡∏∏‡∏î‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï/‡πÅ‡∏ú‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏•‡∏≤‡∏î)",
        "‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏∞? (‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏•‡πÑ‡∏°‡πâ ‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤ ‡∏Ç‡∏≠‡∏á‡∏ù‡∏≤‡∏Å ‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ ‡∏Ø‡∏•‡∏Ø)",
        "‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏µ‡πà‡πÇ‡∏°‡∏á‡∏Ñ‡∏∞?",
        "‡∏°‡∏µ‡∏à‡∏∏‡∏î‡πÄ‡∏î‡πà‡∏ô/‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡∏ö‡∏≠‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ö‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞?",
        "‡∏°‡∏µ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏ã‡πÄ‡∏ä‡∏µ‡∏¢‡∏•‡∏°‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏Ç‡∏≠‡∏á‡∏£‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏°‡∏Ñ‡∏∞?",
      ],
    };

    /* ‡∏à‡∏±‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏à‡∏≤‡∏Å‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î (‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô) */
    function detectCategory(message){
      const msg = (message || "").toLowerCase().trim();
      const kwActivity = ['‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°','‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°','‡∏á‡∏≤‡∏ô','event','‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ó‡πå','‡∏à‡∏±‡∏î‡∏á‡∏≤‡∏ô','‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏Å‡∏ä‡πá‡∏≠‡∏õ','workshop'];
      const kwPlace    = ['‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà','‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß','‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß','‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß','‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß','‡πÅ‡∏•‡∏ô‡∏î‡πå‡∏°‡∏≤‡∏£‡πå‡∏Å','place','‡πÅ‡∏´‡∏•‡πà‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß','tourist'];
      const kwRestaurant=['‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏¥‡∏ô','‡∏Å‡∏¥‡∏ô','‡∏Ç‡∏≠‡∏á‡∏Å‡∏¥‡∏ô','‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà','‡∏£‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡πÅ‡∏ü','restaurant','‡πÄ‡∏°‡∏ô‡∏π','cafe','coffee'];
      const kwHotel    = ['‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°','‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å','‡πÇ‡∏Æ‡∏™‡πÄ‡∏ó‡∏•','‡∏£‡∏µ‡∏™‡∏≠‡∏£‡πå‡∏ó','‡πÄ‡∏Å‡∏™‡∏ï‡πå‡πÄ‡∏Æ‡πâ‡∏≤‡∏™‡πå','hotel','hostel','‡∏à‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å','‡∏´‡πâ‡∏≠‡∏á‡∏û‡∏±‡∏Å','resort'];
      const kwShop     = ['‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤','‡∏ï‡∏•‡∏≤‡∏î','‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á','‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢‡∏ú‡∏•‡πÑ‡∏°‡πâ','‡πÅ‡∏ú‡∏á‡∏ú‡∏•‡πÑ‡∏°‡πâ','shop','market','store','‡∏Ç‡∏≠‡∏á‡∏ù‡∏≤‡∏Å','‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ','‡∏Ñ‡πâ‡∏≤‡∏õ‡∏•‡∏µ‡∏Å','‡∏Ç‡∏≤‡∏¢‡∏ú‡∏•‡πÑ‡∏°‡πâ','‡∏ã‡∏∏‡∏õ‡πÄ‡∏õ‡∏≠‡∏£‡πå','‡∏°‡∏¥‡∏ô‡∏¥‡∏°‡∏≤‡∏£‡πå‡∏ó'];
      const hit = (arr) => arr.some(k => msg.includes(k));
      if (hit(kwActivity))   return 'activity';
      if (hit(kwPlace))      return 'place';
      if (hit(kwRestaurant)) return 'restaurant';
      if (hit(kwHotel))      return 'hotel';
      if (hit(kwShop))       return 'shop';
      return null;
    }

    function speakThai(text) {
      const cleaned = text.replace(/[\p{Emoji_Presentation}\p{Emoji}\u200d]+/gu, "");
      if ("speechSynthesis" in window) {
        const u = new SpeechSynthesisUtterance(cleaned);
        u.lang = "th-TH";
        const v = speechSynthesis.getVoices().filter(x => x.lang.startsWith("th"));
        if (v.length > 0) u.voice = v[0];
        speechSynthesis.speak(u);
      }
    }

    function addBubble(text, sender) {
      const div = document.createElement("div");
      div.className = "bubble " + sender;
      div.textContent = text;
      chatMessages.appendChild(div);
      scrollChatToBottom();
    }
    function reply(text){ addBubble(text, "ai"); speakThai(text); }

    function toggleChat() {
      const visible = chatBox.style.display === "flex";
      if (visible) {
        minimizeChat();
      } else {
        showChat();
        if (chatMessages.childElementCount === 0) {
          const greeting = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞‡∏ä‡∏∏‡∏°‡∏ä‡∏ô ${communityName} ‡∏û‡∏•‡∏≠‡∏¢‡πÉ‡∏™‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡πÉ‡∏´‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏∞ üå∏`;
          reply(greeting);
          setTimeout(() => {
            reply("‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏≤‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå‡πÅ‡∏ö‡∏ö‡πÑ‡∏´‡∏ô‡∏Ñ‡∏∞ (‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß, ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤, ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°)?");
          }, 1200);
        }
      }
    }

    function sendMsg(text) {
      const message = text || userInput.value.trim();
      if (!message) return;
      addBubble(message, "user");
      userInput.value = "";

      if (editingIndex !== null) {
        currentData[editingIndex] = message;
        editingIndex = null;
        showPreview();
        return;
      }

      if (step === 0) {
        const detected = detectCategory(message);
        if (!detected) {
          reply("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß / ‡∏£‡πâ‡∏≤‡∏ô‡∏≠‡∏≤‡∏´‡∏≤‡∏£ / ‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤ / ‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏° (‡πÄ‡∏ä‡πà‡∏ô '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', '‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß', '‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà', '‡∏ï‡∏•‡∏≤‡∏î', '‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å')");
          return;
        }
        selectedType = detected;
        step = 1; currentData = {}; askNext();
      } else {
        const questions = templates[selectedType];
        currentData[step - 1] = message;
        step++;
        if (step <= questions.length) { askNext(); } else { showPreview(); step = 0; }
      }
    }

    function askNext(){ const q = templates[selectedType][step - 1]; reply(q); }

    /* ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Audience + ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô */
    function renderAudienceSelector(){
      const checkedTeen   = targetAudience === 'teen'   ? 'checked' : '';
      const checkedWork   = targetAudience === 'work'   ? 'checked' : '';
      const checkedSenior = targetAudience === 'senior' ? 'checked' : '';

      return `
        <fieldset class="audience">
          <legend>üéØ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</legend>
          <div class="opts">
            <label><input type="radio" name="audience" value="teen" ${checkedTeen}> ‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô</label>
            <label><input type="radio" name="audience" value="work" ${checkedWork}> ‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</label>
            <label><input type="radio" name="audience" value="senior" ${checkedSenior}> ‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏</label>
          </div>
        </fieldset>
      `;
    }

    function showPreview(){
      const labels = templates[selectedType];
      let html = '<div class="activity-box">';
      labels.forEach((label, i) => {
        html += `<p><b>${label}</b> ${currentData[i] || ""} <button class="btn secondary" style="padding:4px 8px" onclick="editField(${i})">‚úèÔ∏è</button></p>`;
      });
      html += renderAudienceSelector();
      html += `<div class="row" style="margin-top:10px"><button class="btn" onclick="confirmActivity()">‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button></div></div>`;
      activityPreview.innerHTML = html;

      // ‡πÅ‡∏à‡πâ‡∏á + ‡∏¢‡πà‡∏≠‡πÅ‡∏ä‡∏ó‡∏ó‡∏∏‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
      reply("‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πà‡∏∞ ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏î‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢");
      setTimeout(minimizeChat, 400);
    }

    /* ‡∏ü‡∏±‡∏á change ‡∏Ç‡∏≠‡∏á radio audience (event delegation ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ element ‡∏ñ‡∏π‡∏Å render ‡πÅ‡∏ö‡∏ö‡πÑ‡∏î‡∏ô‡∏≤‡∏°‡∏¥‡∏Å) */
    document.addEventListener('change', (e) => {
      const t = e.target;
      if (t && t.name === 'audience') {
        targetAudience = t.value; // 'teen' | 'work' | 'senior'
      }
    });

    function editField(index){
      editingIndex = index;
      const q = templates[selectedType][index];
      showChat();
      reply("‡∏ï‡∏Å‡∏•‡∏á‡∏Ñ‡πà‡∏∞ ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡∏°‡πà‡∏ô‡∏∞‡∏Ñ‡∏∞");
      setTimeout(() => { reply(q); scrollChatToBottom(); }, 300);
    }

    function confirmActivity(){
      const labels = templates[selectedType];
      let html = '<div class="activity-box">';
      labels.forEach((label, i) => { html += `<p><b>${label}</b> ${currentData[i] || ""}</p>`; });
      html += `<p><b>‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</b> ${targetAudience === 'teen' ? '‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô' : targetAudience === 'senior' ? '‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏' : '‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'}</p>`;
      html += `<div class="row"><button class="btn" onclick="generateContent()">‚ú® ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏î‡πâ‡∏ß‡∏¢ AI</button></div></div>`;
      const div = document.createElement("div");
      div.className = "activity-box";
      div.innerHTML = html;
      activityList.prepend(div);
      activityPreview.innerHTML = "";
      reply("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ üéâ");

      /* ---- Google Sheet: ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1 (‡∏ï‡∏≠‡∏ô‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô) ---- */
      sendToSheet({
        communityName,
        type: selectedType,
        answers: { ...currentData, _audience: targetAudience },
        aiContent: ''
      });
    }

    function audienceGuideline(){
      if (targetAudience === 'teen') {
        return "‡πÇ‡∏ó‡∏ô‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô ‡∏™‡∏ô‡∏∏‡∏Å ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏á‡πà‡∏≤‡∏¢ ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡πÑ‡∏°‡πà‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏ô‡πâ‡∏ô‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ‡∏ä‡∏ß‡∏ô‡πÅ‡∏ä‡∏£‡πå";
      }
      if (targetAudience === 'senior') {
        return "‡πÇ‡∏ó‡∏ô‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏™‡∏±‡πâ‡∏ô ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡∏´‡∏•‡∏µ‡∏Å‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏®‡∏±‡∏û‡∏ó‡πå‡∏™‡πÅ‡∏•‡∏á ‡πÄ‡∏ô‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏ß‡∏•‡∏≤/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà/‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠";
      }
      return "‡πÇ‡∏ó‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÄ‡∏ô‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå ‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°";
    }

    async function generateContent(){
      const labels = templates[selectedType];
      let prompt = `‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏´‡∏°‡∏ß‡∏î "${selectedType}" ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏µ‡πâ:\n`;
      labels.forEach((label, i) => prompt += `- ${label}: ${currentData[i] || "-"}\n`);
      const audThai = targetAudience === 'teen' ? '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô' : targetAudience === 'senior' ? '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏π‡πâ‡∏™‡∏π‡∏á‡∏≠‡∏≤‡∏¢‡∏∏' : '‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ß‡∏±‡∏¢‡∏ó‡∏≥‡∏á‡∏≤‡∏ô';
      prompt += `\n‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢: ${audThai}\n‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°‡∏ï‡∏≤‡∏°‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á: ${audienceGuideline()}\n`;
      prompt += `‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï: ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ 1-2 ‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ñ‡∏≥‡∏ä‡∏ß‡∏ô‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡πâ‡∏≤‡∏¢‡πÇ‡∏û‡∏™‡∏ï‡πå`;

      reply("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏à‡∏≤‡∏Å AI ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà...");
      const backendUrl = getBackendUrl();
      try{
        const data = await fetchJSON(backendUrl, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ prompt })
        });
        const content = data?.content;
        if(content){
          aiContentEl.textContent = content;
          aiBox.style.display = "block";
          reply("‡∏û‡∏•‡∏≠‡∏¢‡πÉ‡∏™‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏∞ ‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏î‡∏π‡∏ô‡∏∞‡∏Ñ‡∏∞ üòä");
          setTimeout(minimizeChat, 200);

          /* ---- Google Sheet: ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 2 (‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ AI) ---- */
          sendToSheet({
            communityName,
            type: selectedType,
            answers: { ...currentData, _audience: targetAudience },
            aiContent: content
          });
        }else{
          reply("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ");
        }
      }catch(err){
        console.error(err);
        reply("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ AI ("+ err.message +")");
      }
    }

    /* ---------- ‡∏¢‡πà‡∏≠‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡πâ‡∏™‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ---------- */
    async function shortenContent(){
      const current = aiContentEl.textContent.trim();
      if (!current) {
        alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÉ‡∏´‡πâ‡∏¢‡πà‡∏≠‡∏Ñ‡πà‡∏∞ ‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏û‡∏™‡∏ï‡πå‡∏î‡πâ‡∏ß‡∏¢ AI ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞");
        return;
      }
      const prevText = shortenBtn.textContent;
      shortenBtn.disabled = true;
      shortenBtn.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡πà‡∏≠...";

      reply("‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏û‡∏•‡∏≠‡∏¢‡πÉ‡∏™‡∏ä‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡∏ô‡∏∞‡∏Ñ‡∏∞ ‚úÇÔ∏è");

      const backendUrl = getBackendUrl();
      const shortenPrompt =
        "‡∏ä‡πà‡∏ß‡∏¢‡∏¢‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ '‡∏™‡∏±‡πâ‡∏ô ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢ ‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏ß‡∏±‡∏¢‡∏£‡∏∏‡πà‡∏ô/‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ' " +
        "‡πÄ‡∏ô‡πâ‡∏ô‡πÉ‡∏à‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç, ‡∏ï‡∏±‡∏î‡∏Ñ‡∏≥‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô, ‡πÉ‡∏ä‡πâ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏™‡∏±‡πâ‡∏ô, ‡πÑ‡∏°‡πà‡πÄ‡∏ß‡∏¥‡πà‡∏ô‡πÄ‡∏ß‡πâ‡∏≠, " +
        "‡πÄ‡∏•‡∏µ‡πà‡∏¢‡∏á‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥/‡πÅ‡∏Æ‡∏ä‡πÅ‡∏ó‡πá‡∏Å‡πÄ‡∏¢‡∏≠‡∏∞‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ï‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ 1 ‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥‡πÑ‡∏î‡πâ), " +
        "‡∏¢‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 120‚Äì280 ‡∏≠‡∏±‡∏Å‡∏Ç‡∏£‡∏∞:\n\n" + current;

      try{
        const data = await fetchJSON(backendUrl, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ prompt: shortenPrompt })
        });
        const concise = data?.content?.trim();
        if (!concise) throw new Error("‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö");

        aiContentEl.textContent = concise;
        reply("‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞ ‚Äî ‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏ä‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏•‡∏≠‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏î‡∏π‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ü§è");
        setTimeout(minimizeChat, 200);

        /* ---- Google Sheet: ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 3 (‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏¢‡πà‡∏≠) ---- */
        sendToSheet({
          communityName,
          type: selectedType,
          answers: { ...currentData, _audience: targetAudience },
          aiContent: concise
        });
      }catch(err){
        console.error(err);
        reply("‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢ ‡∏¢‡πà‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ ("+ err.message +")");
      }finally{
        shortenBtn.disabled = false;
        shortenBtn.textContent = prevText;
      }
    }

    function startVoice(){
      if (!("webkitSpeechRecognition" in window)) { alert("‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Speech Recognition"); return; }
      const recognition = new webkitSpeechRecognition();
      recognition.lang = "th-TH"; recognition.interimResults = false; recognition.maxAlternatives = 1; recognition.start();
      recognition.onresult = (e) => { const transcript = e.results[0][0].transcript; sendMsg(transcript); };
      recognition.onerror = (e) => console.error("Voice error:", e.error);
    }

    userInput.addEventListener("keydown", function (event) {
      if (event.key === "Enter") { event.preventDefault(); sendMsg(); }
    });

    function copyPostText(){
      const content = aiContentEl.innerText;
      navigator.clipboard.writeText(content)
        .then(() => alert("üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÑ‡∏õ‡∏ß‡∏≤‡∏á‡πÉ‡∏ô‡πÇ‡∏û‡∏™‡∏ï‡πå Facebook"))
        .catch(() => alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å"));
    }

    function openFacebookPost(){
      const content = aiContentEl.innerText;
      const fbUrl = `https://www.facebook.com/sharer/sharer.php?quote=${encodeURIComponent(content)}`;
      window.open(fbUrl, "_blank");
    }
  </script>
</body>
</html>
